# Kafka调优-硬件配置选择

### 一、场景说明

- 100万日活，每人每天100条日志，每天总共的日志条数是100万 * 100条 = 1亿条。
- 1亿/24小时/60分/60秒 = 1150条/每秒钟。
- 每条日志大小：0.5k - 2k（取1k）。
- 1150条/每秒钟 * 1k ≈ 1m/s 。
- 高峰期每秒钟：1150条 * 20倍 = 23000条。
- 每秒多少数据量：20MB/s。

### 二、服务器台数选择

服务器台数
= 2 * （生产者峰值生产速率 * 副本 / 100） + 1
= 2 * （20m/s * 2 / 100） + 1
= 3台

建议3台服务器。

### 三、磁盘选择

kafka底层主要是顺序写，固态硬盘和机械硬盘的顺序写速度差不多。
建议选择普通的机械硬盘。
每天总数据量：1亿条 * 1k ≈ 100g
100g * 副本2 * 保存时间3天 / 0.7 ≈ 1T

建议三台服务器硬盘总大小，大于等于1T。

### 四、内存选择

Kafka内存组成：堆内存 + 页缓存

#### 1、Kafka堆内存建议每个节点：10g ~ 15g

1. 在`kafka-server-start.sh`中修改

```shell
if [ "x$KAFKA_HEAP_OPTS" = "x" ]; then
export KAFKA_HEAP_OPTS="-Xmx10G -Xms10G"
fi
```

2. 根据Kafka进程号，查看Kafka的GC情况

```shell
jps
jstat -gc 进程号 1s 3
#  S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    CCSC   CCSU   YGC     YGCT    FGC    FGCT     GCT   
# 38400.0 14848.0  0.0   14585.4 4077056.0 984838.2 1417728.0   183149.8  110464.0 98982.0 14464.0 11866.6    159    1.104   4      0.320    1.424
# 38400.0 14848.0  0.0   14585.4 4077056.0 984838.2 1417728.0   183149.8  110464.0 98982.0 14464.0 11866.6    159    1.104   4      0.320    1.424
# 38400.0 14848.0  0.0   14585.4 4077056.0 984838.2 1417728.0   183149.8  110464.0 98982.0 14464.0 11866.6    159    1.104   4      0.320    1.424
```

参数说明：

- S0C：第一个幸存区的大小；
- S1C：第二个幸存区的大小
- S0U：第一个幸存区的使用大小；
- S1U：第二个幸存区的使用大小
- EC：伊甸园区的大小；
- EU：伊甸园区的使用大小
- OC：老年代大小；
- OU：老年代使用大小
- MC：方法区大小；
- MU：方法区使用大小
- CCSC:压缩类空间大小；
- CCSU:压缩类空间使用大小
- YGC：年轻代垃圾回收次数；
- YGCT：年轻代垃圾回收消耗时间
- FGC：老年代垃圾回收次数；
- FGCT：老年代垃圾回收消耗时间
- GCT：垃圾回收消耗总时间；

3. 根据Kafka进程号，查看Kafka的堆内存

```shell
jmap -heap pid
```

#### 2、页缓存：页缓存是Linux系统服务器的内存。我们只需要保证1个segment（1g）中25%的数据在内存中就好。

每个节点页缓存大小 =（分区数 * 1g * 25%）/ 节点数。
例如10个分区，页缓存大小=（10 * 1g * 25%）/ 3 ≈ 1g

建议服务器内存大于等于11G。

### 五、CPU选择

- num.io.threads = 8 负责写磁盘的线程数，整个参数值要占总核数的50%。
- num.replica.fetchers = 1 副本拉取线程数，这个参数占总核数的50%的1/3。
- num.network.threads = 3 数据传输线程数，这个参数占总核数的50%的2/3。

建议32个cpu core。

### 六、网络选择

- 网络带宽 = 峰值吞吐量 ≈ 20MB/s 选择千兆网卡即可。
- 100Mbps单位是bit；10M/s单位是byte ; 1byte = 8bit，100Mbps/8 = 12.5M/s。
- 一般百兆的网卡（100Mbps ）、千兆的网卡（1000Mbps）、万兆的网卡（10000Mbps）。
